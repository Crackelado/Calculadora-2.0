<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        let y = "";
        let parser = "";
        let xmlDoc = "";
        let x = "";
        let z = "";
        let n = 0;
        let l = "teste";
        const bOK = "<button onclick='salvar()'>OK</button> ";
        const bCancel = "<button onclick='window.location.reload()'>Cancelar</button>";
        const inp = "<input type='text' autofocus><br><br>";
        const arit = "+-*/";
        
        function escolha(cad1, cad2) {
            if (z.getElementsByTagName("select")[0] == null) {
                z.innerHTML = "";
                let pag = "<select onchange=" + cad2 + "><option/>";
                Array.from(cad1, (h) => pag += "<option>" + h.textContent + "</option>");
                pag += "</select>";
                z.innerHTML = pag;
            }
        }

        function contas(cad1, cad2, cad3) {
            z.innerHTML = "";
            let pag = "";

            for (let i = 0; i < cad3.length; i++) {
                pag += "<p>" + cad1[i].textContent + "</p>" + "<h1>" + cad2[i].textContent + "</h1>";

                if (cad3[i].getElementsByTagName("parc")[0] != null) {
                    pag += limitepgast(cad3[i]);
                }
            }
            
            z.innerHTML = pag;
        }
        
        function selec() {
            n = z.getElementsByTagName("select")[0].selectedIndex - 1;
            z.innerHTML = "";
            let l = x.childNodes[n];
            let pag = "<p>" + l.getElementsByTagName("descricao")[0].textContent + "</p>" + "<h1>" + l.getElementsByTagName("total")[0].textContent + "</h1>";
            if (l.getElementsByTagName("parc")[0] != null) {
                Array.from(l.getElementsByTagName("valor"), (h, i) => pag += "<p>R$ " + h.textContent.replace(".", ",") + " - " + l.getElementsByTagName("parc")[i].textContent + " parcelas restantes</p>");
                pag += "<p>R$ " + l.getElementsByTagName("compras")[0].textContent.replace(".", ",") + " - compras realizada no mês</p>";
            }
            
            z.setAttribute("onclick", "");
            z.innerHTML = pag + inp + bOK + bCancel;
        }

        function iniciar() {
            if (y == "") {
                y = window.localStorage;
                parser = new DOMParser();
                xmlDoc = parser.parseFromString(y.getItem(l), "text/xml")
                x = xmlDoc.childNodes[0];
                z = document.body;
            }
            
            z.setAttribute("onclick", "escolha(x.getElementsByTagName('descricao'), 'selec()')");
            contas(x.getElementsByTagName("descricao"), x.getElementsByTagName("total"), x.childNodes);
        }

        function limitepgast(cad1) {
            let soma = 0;
            Array.from(cad1.getElementsByTagName("parc"), (h, i) => soma += +h.textContent * +cad1.getElementsByTagName("valor")[i].textContent);

            if (cad1.getElementsByTagName("compras")[0] != null) {
                soma += +cad1.getElementsByTagName("compras")[0].textContent;
            }

            soma = Number(+cad1.getElementsByTagName("limite")[0].textContent - soma).toFixed(2);
            return "<p>Limite restante: R$ " + soma.toString().replace(".", ",") + "</p><br>";
        }

        function equacao(cad1, cad2, cad3) {
            try {
                // if (isNaN(cad2)) throw "Esse valor não é um número.";
                // if (!(cad2 > -1)) throw "Nenhum valor digitado.";
                if (arit.includes(cad3) == false) throw "Não há sinal de operação aritmética.";
                // cad2 = Number(cad2);
                cad1 = Number(cad1);
                if (cad3 == "+") return (cad1 + cad2).toFixed(2);
                if (cad3 == "-") return (cad1 - cad2).toFixed(2);
                if (cad3 == "*") return (cad1 * cad2).toFixed(2);
                if (cad3 == "/") return (cad1 / cad2).toFixed(2);
            }
            catch(err) {
                // alert(err);
            }
        }

        function numero(cad1) {
            cad1 = cad1.replaceAll(",", ".");
            let tP = cad1.lastIndexOf(".");
            let tN = cad1.slice(0, tP).replaceAll(".", "");

            if (isNaN(Number(cad1.replaceAll(".", ""))) == false) {
                if (tP > -1) {
                    tN += Number(cad1.slice(tP)).toFixed(2).slice(-3);
                    return tN;
                }
                else {
                    return cad1;
                }
            }
        }

        function loopAritmetico(cad1) {
            let t = [new Array(), new Array()];
            t[1][0] = cad1;

            for (let i in cad1) {
                if (arit.includes(cad1[i])) {
                    t[0].push(cad1[i]);

                    if (i > 0) {
                        t[1][0] = t[1][0].replace(cad1[i], ";");
                    }
                    else {
                        t[1][0] = t[1][0].replace(cad1[i], "0");
                    }
                }
            }

            t[1] = t[1][0].split(";");
            t[1] = Array.from(t[1], (h) => Number(numero(h)));

            if (t[0].length != t[1].length) {
                t[0].unshift("+");
            }

            return t;
        }

        function salvar() {
            let texto = z.getElementsByTagName("input")[0];
            let t = loopAritmetico(texto.value);

            if (t != "") {
                let t1 = "";
                let t2 = "";
                let t3 = "";
                
                if (x.childNodes[n].getElementsByTagName("compras")[0] == null) {
                    t2 = x.childNodes[n].getElementsByTagName("total")[0];
                    t1 = t2.textContent.slice(3).replace(",", ".");         
                    t1 = erroNaN(t1, t[1], t[0]);

                    if (!(isNaN(t1))) {
                        t2.textContent = "R$ " + t1.replace(".", ",");
                    }
                }
                else {
                    t2 = x.childNodes[n].getElementsByTagName("compras")[0];
                    t3 = x.childNodes[n].getElementsByTagName("total")[0];
                    t1 = t2.textContent;                    
                    t1 = erroNaN(t1, t[1], t[0]);
                    t2.textContent = t1;
                    t1 = t3.textContent.slice(3).replace(",", ".");
                    t1 = erroNaN(t1, t[1], t[0]);
                    t3.textContent = "R$ " + t1.replace(".", ",");
                }
                
                if (!(isNaN(t1))) {
                    y.setItem(l, x.outerHTML);
                    y = "";
                    window.location.reload();
                }
                else {
                    texto.focus();
                }
            }
        }

        function erroNaN(cad1, cad2, cad3) {
            for (let i in cad2) {
                cad1 = equacao(cad1, cad2[i], cad3[i]);

                if (isNaN(cad1)) {
                    alert("Parâmetro " + (+i+1) + " da expressão incorreto");
                    break;
                }
            }

            return cad1;
        }

    </script>
</head>
<body onload="iniciar()">
    
</body>
</html>